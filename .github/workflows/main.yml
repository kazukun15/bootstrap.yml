name: Bootstrap & Build Android App (Car Launcher Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. プロジェクト生成フェーズ
      # ---------------------------------------------------------
      - name: Generate project files (Fix Compile Error)
        id: generate
        shell: bash
        run: |
          echo "Generating Android project files..."
          set -euxo pipefail

          # ディレクトリ作成
          mkdir -p app/src/main/java/jp/kamijima/cyberbriefing/{car,net,notify,worker}
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/xml
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/drawable-v24

          # --- Root Files ---
          cat > settings.gradle.kts <<'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "CyberDailyBriefing"
          include(":app")
          EOF

          cat > build.gradle.kts <<'EOF'
          plugins {
              id("com.android.application") version "8.3.2" apply false
              id("org.jetbrains.kotlin.android") version "1.9.24" apply false
          }
          EOF

          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.nonTransitiveRClass=true
          kotlin.code.style=official
          EOF

          # --- App Build Config ---
          cat > app/build.gradle.kts <<'EOF'
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "jp.kamijima.cyberbriefing"
              compileSdk = 35

              defaultConfig {
                  applicationId = "jp.kamijima.cyberbriefing"
                  minSdk = 26
                  targetSdk = 35
                  versionCode = 1
                  versionName = "1.0.0"
              }

              buildFeatures { 
                  buildConfig = true 
                  viewBinding = true
              }

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.13.1")
              implementation("androidx.appcompat:appcompat:1.7.0")
              implementation("com.google.android.material:material:1.12.0")
              implementation("androidx.constraintlayout:constraintlayout:2.1.4")
              implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.8.4")
              implementation("androidx.lifecycle:lifecycle-service:2.8.4")
              implementation("com.google.android.gms:play-services-location:21.3.0")
              implementation("com.squareup.okhttp3:okhttp:4.12.0")
              
              // Android Auto Library
              implementation("androidx.car.app:app:1.4.0")
          }
          EOF

          cat > app/proguard-rules.pro <<'EOF'
          # (empty)
          EOF

          # --- Manifest ---
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
              <uses-permission android:name="android.permission.INTERNET"/>
              
              <uses-feature android:name="android.hardware.type.automotive" android:required="false" />

              <application
                  android:allowBackup="true"
                  android:label="@string/app_name"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:supportsRtl="true"
                  android:theme="@style/Theme.CyberDailyBriefing">

                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".car.BriefingCarAppService"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="androidx.car.app.CarAppService" />
                      </intent-filter>
                  </service>
                  
                  <meta-data
                      android:name="androidx.car.app.minCarApiLevel"
                      android:value="1" />
              </application>
          </manifest>
          EOF

          # --- Resources ---
          cat > app/src/main/res/values/strings.xml <<'EOF'
          <resources>
              <string name="app_name">Cyber Daily Briefing</string>
              <string name="phone_status">準備完了。\nAndroid Autoのメニューから\n「Cyber Briefing」\nを起動してください。</string>
              <string name="loading">データ取得中...</string>
              <string name="error_fetch">データの取得に失敗しました</string>
              <string name="btn_read">読み上げ</string>
          </resources>
          EOF

          cat > app/src/main/res/values/themes.xml <<'EOF'
          <resources>
              <style name="Theme.CyberDailyBriefing" parent="Theme.Material3.DayNight.NoActionBar"/>
          </resources>
          EOF

          cat > app/src/main/res/layout/activity_main.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:app="http://schemas.android.com/apk/res-auto"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:padding="24dp"
              android:background="#101820">
              <TextView
                  android:id="@+id/tvStatus"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="@string/phone_status"
                  android:textColor="#00E5FF"
                  android:textSize="20sp"
                  android:textAlignment="center"
                  app:layout_constraintTop_toTopOf="parent"
                  app:layout_constraintBottom_toBottomOf="parent"
                  app:layout_constraintStart_toStartOf="parent"
                  app:layout_constraintEnd_toEndOf="parent"/>
          </androidx.constraintlayout.widget.ConstraintLayout>
          EOF

          # --- Icons ---
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<'EOF'
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml <<'EOF'
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<'EOF'
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#101820" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF
          cat > app/src/main/res/drawable-v24/ic_launcher_foreground.xml <<'EOF'
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#00E5FF" android:pathData="M28,54h52v4h-52z"/>
              <path android:fillColor="#00E5FF" android:pathData="M54,28h4v52h-4z"/>
              <path android:fillColor="#00E5FF" android:pathData="M24,24h8v8h-8z"/>
              <path android:fillColor="#00E5FF" android:pathData="M76,24h8v8h-8z"/>
              <path android:fillColor="#00E5FF" android:pathData="M24,76h8v8h-8z"/>
              <path android:fillColor="#00E5FF" android:pathData="M76,76h8v8h-8z"/>
          </vector>
          EOF

          # --- Kotlin Code ---
          
          # 1. Main Activity
          cat > app/src/main/java/jp/kamijima/cyberbriefing/MainActivity.kt <<'EOF'
          package jp.kamijima.cyberbriefing
          import android.Manifest
          import android.os.Bundle
          import androidx.activity.ComponentActivity
          import androidx.activity.result.contract.ActivityResultContracts
          class MainActivity : ComponentActivity() {
              private val requestPermissions =
                  registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions()) {}
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
                  requestPermissions.launch(arrayOf(Manifest.permission.ACCESS_COARSE_LOCATION, Manifest.permission.ACCESS_FINE_LOCATION))
              }
          }
          EOF

          # 2. Car App Service
          cat > app/src/main/java/jp/kamijima/cyberbriefing/car/BriefingCarAppService.kt <<'EOF'
          package jp.kamijima.cyberbriefing.car
          import android.content.Intent
          import androidx.car.app.CarAppService
          import androidx.car.app.Session
          import androidx.car.app.validation.HostValidator
          class BriefingCarAppService : CarAppService() {
              override fun createHostValidator(): HostValidator = HostValidator.ALLOW_ALL_HOSTS_VALIDATOR
              override fun onCreateSession(): Session = BriefingSession()
          }
          EOF

          # 3. Session (Fixed super.onDestroy)
          cat > app/src/main/java/jp/kamijima/cyberbriefing/car/BriefingSession.kt <<'EOF'
          package jp.kamijima.cyberbriefing.car
          import android.content.Intent
          import android.speech.tts.TextToSpeech
          import androidx.car.app.Screen
          import androidx.car.app.Session
          import androidx.lifecycle.DefaultLifecycleObserver
          import androidx.lifecycle.LifecycleOwner
          import java.util.Locale

          class BriefingSession : Session(), DefaultLifecycleObserver {
              var tts: TextToSpeech? = null

              override fun onCreateScreen(intent: Intent): Screen {
                  lifecycle.addObserver(this)
                  // Init TTS
                  tts = TextToSpeech(carContext) { status ->
                      if (status == TextToSpeech.SUCCESS) {
                          tts?.language = Locale.JAPAN
                      }
                  }
                  return BriefingScreen(carContext, this)
              }
              
              override fun onDestroy(owner: LifecycleOwner) {
                  tts?.shutdown()
                  // super.onDestroy(owner) は不要（コンパイルエラー原因のため削除）
              }
          }
          EOF

          # 4. Screen
          cat > app/src/main/java/jp/kamijima/cyberbriefing/car/BriefingScreen.kt <<'EOF'
          package jp.kamijima.cyberbriefing.car
          import android.text.SpannableString
          import android.text.Spanned
          import androidx.car.app.CarContext
          import androidx.car.app.Screen
          import androidx.car.app.model.*
          import androidx.lifecycle.lifecycleScope
          import jp.kamijima.cyberbriefing.net.LocationProvider
          import jp.kamijima.cyberbriefing.net.OnThisDayClient
          import jp.kamijima.cyberbriefing.net.WeatherClient
          import jp.kamijima.cyberbriefing.notify.BriefingComposer
          import kotlinx.coroutines.launch
          import java.time.LocalDate

          class BriefingScreen(carContext: CarContext, private val session: BriefingSession) : Screen(carContext) {
              private var message: String = "データを取得しています..."
              private var isLoading = true

              init {
                  loadData()
              }

              private fun loadData() {
                  lifecycleScope.launch {
                      try {
                          val loc = LocationProvider(carContext).getCurrentLocationOrNull()
                          val d = LocalDate.now()
                          val mm = d.monthValue.toString().padStart(2, '0')
                          val dd = d.dayOfMonth.toString().padStart(2, '0')
                          val onThisDay = OnThisDayClient().fetchOneEventJa(mm, dd)
                          val weather = if (loc != null) WeatherClient().fetchWeatherSummary(loc.latitude, loc.longitude) else null
                          message = BriefingComposer.composeCyber(mm, dd, onThisDay, weather)
                      } catch (e: Exception) {
                          message = "エラーが発生しました: ${e.localizedMessage}"
                      } finally {
                          isLoading = false
                          invalidate()
                          speak()
                      }
                  }
              }

              private fun speak() {
                  session.tts?.speak(message, android.speech.tts.TextToSpeech.QUEUE_FLUSH, null, "briefing")
              }

              override fun onGetTemplate(): Template {
                  val paneBuilder = Pane.Builder()
                  
                  if (isLoading) {
                      paneBuilder.setLoading(true)
                  } else {
                      paneBuilder.addRow(Row.Builder().setTitle("Cyber Daily Briefing").addText(message).build())
                      paneBuilder.addAction(
                          Action.Builder()
                              .setTitle("読み上げ")
                              .setOnClickListener { speak() }
                              .build()
                      )
                  }

                  return PaneTemplate.Builder(paneBuilder.build())
                      .setTitle("Cyber Briefing")
                      .build()
              }
          }
          EOF

          # 5. Utilities
          cat > app/src/main/java/jp/kamijima/cyberbriefing/net/LocationProvider.kt <<'EOF'
          package jp.kamijima.cyberbriefing.net
          import android.annotation.SuppressLint
          import android.content.Context
          import com.google.android.gms.location.LocationServices
          import kotlinx.coroutines.suspendCancellableCoroutine
          import kotlin.coroutines.resume
          data class SimpleLocation(val latitude: Double, val longitude: Double)
          class LocationProvider(private val context: Context) {
              @SuppressLint("MissingPermission")
              suspend fun getCurrentLocationOrNull(): SimpleLocation? {
                  val client = LocationServices.getFusedLocationProviderClient(context)
                  return suspendCancellableCoroutine { cont ->
                      client.lastLocation.addOnSuccessListener { loc -> cont.resume(loc?.let { SimpleLocation(it.latitude, it.longitude) }) }.addOnFailureListener { cont.resume(null) }
                  }
              }
          }
          EOF

          cat > app/src/main/java/jp/kamijima/cyberbriefing/net/OnThisDayClient.kt <<'EOF'
          package jp.kamijima.cyberbriefing.net
          import okhttp3.OkHttpClient
          import okhttp3.Request
          import org.json.JSONObject
          class OnThisDayClient {
              private val http = OkHttpClient()
              suspend fun fetchOneEventJa(mm: String, dd: String): String? {
                  val url = "https://api.wikimedia.org/feed/v1/wikipedia/ja/onthisday/events/$mm/$dd"
                  val req = Request.Builder().url(url).header("User-Agent", "CyberDailyBriefing/1.0").build()
                  http.newCall(req).execute().use { res ->
                      if (!res.isSuccessful) return null
                      val body = res.body?.string() ?: return null
                      val events = JSONObject(body).optJSONArray("events") ?: return null
                      var best: String? = null
                      var bestLen = Int.MAX_VALUE
                      for (i in 0 until events.length()) {
                          val text = events.getJSONObject(i).optString("text").trim()
                          if (text.isBlank()) continue
                          val len = text.length
                          if (len in 25..80 && len < bestLen) { best = text; bestLen = len }
                      }
                      if (best == null && events.length() > 0) best = events.getJSONObject(0).optString("text").trim().ifBlank { null }
                      return best
                  }
              }
          }
          EOF

          cat > app/src/main/java/jp/kamijima/cyberbriefing/net/WeatherClient.kt <<'EOF'
          package jp.kamijima.cyberbriefing.net
          import okhttp3.OkHttpClient
          import okhttp3.Request
          import org.json.JSONObject
          import kotlin.math.roundToInt
          class WeatherClient {
              private val http = OkHttpClient()
              suspend fun fetchWeatherSummary(lat: Double, lon: Double): String? {
                  val url = "https://api.open-meteo.com/v1/forecast?latitude=$lat&longitude=$lon&hourly=precipitation_probability,temperature_2m&current_weather=true&timezone=Asia%2FTokyo"
                  http.newCall(Request.Builder().url(url).build()).execute().use { res ->
                      if (!res.isSuccessful) return null
                      val body = res.body?.string() ?: return null
                      val json = JSONObject(body)
                      val current = json.optJSONObject("current_weather")
                      val hourly = json.optJSONObject("hourly")
                      val probs = hourly?.optJSONArray("precipitation_probability")
                      val tempNow = current?.optDouble("temperature", Double.NaN) ?: Double.NaN
                      var maxProb = -1
                      if (probs != null) {
                          val n = minOf(6, probs.length())
                          for (i in 0 until n) { val p = probs.optInt(i, -1); if (p > maxProb) maxProb = p }
                      }
                      val tStr = if (!tempNow.isNaN()) "${tempNow.roundToInt()}度" else null
                      val probStr = when {
                          maxProb >= 70 -> "雨の確率は高いです"
                          maxProb >= 40 -> "雨の可能性があります"
                          maxProb >= 20 -> "一時的に降るかもしれません"
                          maxProb in 0..19 -> "降雨の心配はありません"
                          else -> null
                      }
                      return listOfNotNull(probStr, tStr?.let { "気温$it" }).joinToString("、").ifBlank { null }
                  }
              }
          }
          EOF

          cat > app/src/main/java/jp/kamijima/cyberbriefing/notify/BriefingComposer.kt <<'EOF'
          package jp.kamijima.cyberbriefing.notify
          object BriefingComposer {
              fun composeCyber(mm: String, dd: String, onThisDay: String?, weather: String?): String {
                  val datePart = "${mm.toInt()}月${dd.toInt()}日"
                  val today = onThisDay?.let { it.replace(Regex("\\s+"), " ").trim() } ?: "過去データなし"
                  val w = weather?.let { it.replace(Regex("\\s+"), " ").trim() } ?: "気象データなし"
                  return "システム通知。本日は${datePart}。${today}。現在地は、${w}。安全運転を開始してください。"
              }
          }
          EOF
          
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Commit generated files
        if: steps.generate.outputs.created == 'true'
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Bootstrap: Fix Compile Error (Session)"
          git push

      # ---------------------------------------------------------
      # 2. ビルド & デプロイフェーズ
      # ---------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.6"

      - name: Build Debug APK
        run: |
          gradle --no-daemon assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: CyberDailyBriefing_Launcher_Fix.apk
          path: app/build/outputs/apk/debug/app-debug.apk
